<!doctype html>
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Scraper</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(45deg, #fff, #e0e7ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .type-item {
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      user-select: none;
    }

    .type-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .type-item.selected {
      background: rgba(124, 58, 237, 0.4);
      border-color: #7c3aed;
    }

    .switch-group {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .switch.on {
      background: #7c3aed;
    }

    .switch-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .switch.on .switch-thumb {
      transform: translateX(26px);
    }

    .btn {
      background: linear-gradient(45deg, #7c3aed, #3b82f6);
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .status {
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .success {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.5);
    }

    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .video-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 0;
      transition: all 0.3s;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .video-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      border-color: rgba(124, 58, 237, 0.5);
    }

    .video-img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      display: block;
    }

    .video-content {
      padding: 15px;
    }

    .video-title {
      font-weight: 600;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
      min-height: 2.8em;
    }

    .video-prediction {
      margin-bottom: 12px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      font-size: 13px;
    }

    .prediction-bar {
      display: flex;
      margin-top: 8px;
      height: 4px;
      border-radius: 2px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.1);
    }

    .prediction-segment {
      height: 100%;
      transition: width 0.3s ease;
    }

    .prediction-segment.drawings {
      background: #10b981;
    }

    .prediction-segment.hentai {
      background: #f59e0b;
    }

    .prediction-segment.neutral {
      background: #6b7280;
    }

    .prediction-segment.porn {
      background: #ef4444;
    }

    .prediction-segment.sexy {
      background: #ec4899;
    }

    .video-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .tag {
      background: rgba(124, 58, 237, 0.6);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      border: 1px solid rgba(124, 58, 237, 0.3);
    }

    .video-links {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .video-link {
      padding: 6px 12px;
      background: rgba(59, 130, 246, 0.6);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 12px;
      transition: all 0.2s;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .video-link:hover {
      background: rgba(59, 130, 246, 0.8);
      transform: scale(1.05);
    }

    .download-link {
      background: rgba(16, 185, 129, 0.6);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .download-link:hover {
      background: rgba(16, 185, 129, 0.8);
    }

    .api-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      flex: 1;
    }

    .hidden {
      display: none;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      color: #60a5fa;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      .types-grid {
        grid-template-columns: 1fr 1fr;
      }

      .header h1 {
        font-size: 2rem;
      }

      .api-buttons {
        flex-direction: column;
      }

      .results-grid {
        grid-template-columns: 1fr;
      }

      .video-links {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header card">
      <h1>🎬 Video Scraper</h1>
      <p>Narzędzie do scrapowania video z AI klasyfikacją</p>
    </div>

    <!-- Form -->
    <div class="card">
      <h3 style="margin-bottom: 20px">Konfiguracja Scrapingu</h3>

      <div class="form-group">
        <label for="url">URL strony:</label>
        <input type="url" id="url" placeholder="https://pl.spankbang.com/" value="https://pl.spankbang.com/" />
      </div>
      <div class="form-group">
        <label for="url">Wyszukania:</label>
        <input type="url" id="url" disabled placeholder="https://pl.spankbang.com/s/maid%20big%20tits/"
          value="https://pl.spankbang.com/s/maid%20big%20tits/" />
      </div>

      <div class="form-group">
        <label for="url">Kanay:</label>
        <input type="url" id="url" disabled placeholder="
        https://pl.spankbang.com/cy/channel/mature+nl/
" value="https://pl.spankbang.com/cy/channel/mature+nl/" />
      </div>
      <div class="form-group">
        <label>Typy treści (0=Drawing, 1=Hentai, 2=Neutral, 3=Porn,
          4=Sexy):</label>
        <div class="types-grid" id="typesGrid">
          <div class="type-item selected" data-type="0">Drawing</div>
          <div class="type-item selected" data-type="1">Hentai</div>
          <div class="type-item selected" data-type="2">Neutral</div>
          <div class="type-item selected" data-type="3">Porn</div>
          <div class="type-item selected" data-type="4">Sexy</div>
        </div>
      </div>

      <div class="form-group">
        <label for="maxVideos">Maksymalna liczba video:</label>
        <input type="number" id="maxVideos" placeholder="10" value="10" min="1" max="1000" />
      </div>

      <div class="form-group">
        <label>Pokaż przeglądarkę:</label>
        <div class="switch-group">
          <div class="switch on" id="browserSwitch">
            <div class="switch-thumb"></div>
          </div>
          <span>Tryb widoczny (headful)</span>
        </div>
      </div>

      <button class="btn" id="startBtn">
        <span id="btnText">Rozpocznij Scraping</span>
        <div class="spinner hidden" id="spinner"></div>
      </button>

      <div class="api-buttons">
        <button class="btn btn-secondary" id="resultsBtn">
          Pokaż Wyniki
        </button>
        <button class="btn btn-secondary" id="hrefsBtn">Pokaż Linki</button>
        <button class="btn btn-secondary" id="cleanupBtn">
          Wyczyść Pliki
        </button>
      </div>
    </div>

    <!-- Status -->
    <div class="card">
      <h3 style="margin-bottom: 15px">Status API</h3>
      <div class="status" id="status">Gotowy do rozpoczęcia</div>
    </div>

    <!-- Results -->
    <div class="card hidden" id="resultsSection">
      <h3 style="margin-bottom: 20px">
        Wyniki (<span id="videoCount">0</span> video)
      </h3>

      <!-- Stats -->
      <div class="stats-grid" id="statsGrid"></div>

      <!-- Videos Grid -->
      <div class="results-grid" id="resultsGrid"></div>
    </div>
  </div>

  <script>
    // Stan aplikacji
    let state = {
      selectedTypes: [0, 1, 2, 3, 4],
      seeBrowser: true,
      isLoading: false,
    };

    // API base URL
    const API_BASE = "https://scrape-1-jqdy.onrender.com";

    // Inicjalizacja
    function init() {
      setupEventListeners();
      checkServerHealth();
    }

    // Sprawdź czy serwer działa
    async function checkServerHealth() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        const data = await response.json();
        updateStatus("Serwer działa poprawnie", "success");
      } catch (error) {
        updateStatus(
          "Błąd połączenia z serwerem. Upewnij się, że serwer Go działa na porcie 8080.",
          "error",
        );
      }
    }

    // Aktualizacja statusu
    function updateStatus(message, type = "") {
      const statusEl = document.getElementById("status");
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    // Event listenery
    function setupEventListeners() {
      // Toggle typów treści
      document.querySelectorAll(".type-item").forEach((item) => {
        item.addEventListener("click", () => {
          const type = parseInt(item.dataset.type);
          if (state.selectedTypes.includes(type)) {
            state.selectedTypes = state.selectedTypes.filter(
              (t) => t !== type,
            );
            item.classList.remove("selected");
          } else {
            state.selectedTypes.push(type);
            item.classList.add("selected");
          }
        });
      });

      // Switch przeglądarki
      document
        .getElementById("browserSwitch")
        .addEventListener("click", () => {
          state.seeBrowser = !state.seeBrowser;
          const switchEl = document.getElementById("browserSwitch");
          switchEl.classList.toggle("on", state.seeBrowser);
        });

      // Przycisk start
      document
        .getElementById("startBtn")
        .addEventListener("click", startScraping);

      // Przyciski API
      document
        .getElementById("resultsBtn")
        .addEventListener("click", loadResults);
      document
        .getElementById("hrefsBtn")
        .addEventListener("click", loadHrefs);
      document
        .getElementById("cleanupBtn")
        .addEventListener("click", cleanup);
    }

    // Rozpocznij scraping
    async function startScraping() {
      if (state.isLoading) return;

      const url =
        document.getElementById("url").value || "https://pl.spankbang.com/";
      const maxVideos = document.getElementById("maxVideos").value || "10";

      if (state.selectedTypes.length === 0) {
        updateStatus("Wybierz przynajmniej jeden typ treści", "error");
        return;
      }

      state.isLoading = true;
      document.getElementById("startBtn").disabled = true;
      document.getElementById("btnText").textContent = "Wysyłanie...";
      document.getElementById("spinner").classList.remove("hidden");

      const payload = {
        baseURL: url,
        type: state.selectedTypes.join(","),
        maxVideos: maxVideos,
        seeBrowser: state.seeBrowser,
      };

      try {
        const response = await fetch(`${API_BASE}/scrape`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (data.status === "success") {
          updateStatus(
            "Scraping rozpoczęty! Przetwarzanie w tle...",
            "success",
          );
          document.getElementById("btnText").textContent =
            "Scraping w toku...";

          // Sprawdzaj wyniki co 5 sekund
          const checkInterval = setInterval(async () => {
            try {
              const resultsResponse = await fetch(`${API_BASE}/results`);
              if (resultsResponse.ok) {
                clearInterval(checkInterval);
                updateStatus(
                  'Scraping zakończony! Kliknij "Pokaż Wyniki" aby zobaczyć video.',
                  "success",
                );
                resetButton();
              }
            } catch (e) {
              // Kontynuuj sprawdzanie
            }
          }, 5000);

          // Timeout po 5 minutach
          setTimeout(() => {
            clearInterval(checkInterval);
            if (state.isLoading) {
              updateStatus(
                "Sprawdź wyniki ręcznie - scraping może trwać dłużej",
                "success",
              );
              resetButton();
            }
          }, 300000);
        } else {
          updateStatus("Błąd: " + data.message, "error");
          resetButton();
        }
      } catch (error) {
        updateStatus("Błąd połączenia: " + error.message, "error");
        resetButton();
      }
    }

    // Reset przycisku
    function resetButton() {
      state.isLoading = false;
      document.getElementById("startBtn").disabled = false;
      document.getElementById("btnText").textContent = "Rozpocznij Scraping";
      document.getElementById("spinner").classList.add("hidden");
    }

    // Załaduj wyniki
    async function loadResults() {
      try {
        updateStatus("Ładowanie wyników...", "");
        const response = await fetch(`${API_BASE}/results`);
        const data = await response.json();

        if (data.status === "success" && data.data && data.data.videos) {
          displayResults(data.data.videos);
          updateStatus(`Załadowano ${data.data.count} video`, "success");
        } else {
          updateStatus("Brak wyników. Najpierw uruchom scraping.", "error");
        }
      } catch (error) {
        updateStatus("Błąd ładowania wyników: " + error.message, "error");
      }
    }

    // Załaduj linki
    async function loadHrefs() {
      try {
        updateStatus("Ładowanie linków...", "");
        const response = await fetch(`${API_BASE}/hrefs`);
        const data = await response.json();

        if (data.status === "success") {
          updateStatus(`Znaleziono ${data.data.count} linków`, "success");

          // Pokaż pierwsze 10 linków
          const hrefsList = data.data.hrefs
            .slice(0, 10)
            .map(
              (href) =>
                `<a href="${href}" target="_blank" style="color: #60a5fa; text-decoration: none;">${href}</a>`,
            )
            .join("<br>");

          document.getElementById("status").innerHTML =
            `Pierwsze 10 z ${data.data.count} linków:<br><br>${hrefsList}`;
        } else {
          updateStatus("Brak linków. Najpierw uruchom scraping.", "error");
        }
      } catch (error) {
        updateStatus("Błąd ładowania linków: " + error.message, "error");
      }
    }

    // Wyczyść pliki
    async function cleanup() {
      try {
        updateStatus("Czyszczenie plików...", "");
        const response = await fetch(`${API_BASE}/cleanup`, {
          method: "DELETE",
        });
        const data = await response.json();

        if (data.status === "success") {
          updateStatus(`Usunięto ${data.data.count} plików`, "success");
          document.getElementById("resultsSection").classList.add("hidden");
        } else {
          updateStatus("Błąd czyszczenia: " + data.message, "error");
        }
      } catch (error) {
        updateStatus("Błąd czyszczenia: " + error.message, "error");
      }
    }

    // Wyświetl wyniki
    function displayResults(videos) {
      const resultsSection = document.getElementById("resultsSection");
      const resultsGrid = document.getElementById("resultsGrid");
      const videoCount = document.getElementById("videoCount");
      const statsGrid = document.getElementById("statsGrid");

      resultsGrid.innerHTML = "";
      videoCount.textContent = videos.length;

      // Wygeneruj statystyki
      displayStats(videos);

      videos.forEach((video, index) => {
        const card = document.createElement("div");
        card.className = "video-card";

        // Pobierz predykcje AI (zgodnie ze strukturą z API)
        const prediction = video.prediction || {};
        const categories = {
          drawings: "Drawing",
          hentai: "Hentai",
          neutral: "Neutral",
          porn: "Porn",
          sexy: "Sexy",
        };

        // Znajdź najwyższą kategorię
        let topCategory = "Unknown";
        let topScore = 0;
        Object.entries(prediction).forEach(([key, value]) => {
          if (typeof value === "number" && value > topScore) {
            topScore = value;
            topCategory = categories[key] || key;
          }
        });

        // Stwórz pasek predykcji
        const predictionBar = Object.entries(prediction)
          .map(([key, value]) => {
            const percentage = value * 100;
            return `<div class="prediction-segment ${key}" style="width: ${percentage}%" title="${categories[key] || key}: ${percentage.toFixed(1)}%"></div>`;
          })
          .join("");

        // Przygotuj tagi
        const tagsHtml = video.tags
          ? video.tags
            .slice(0, 6)
            .map((tag) => `<span class="tag">${tag.name}</span>`)
            .join("")
          : "";

        card.innerHTML = `
            ${video.img ? `<img src="${video.img}" alt="${video.title}" class="video-img" loading="lazy" onerror="this.style.display='none'">` : ""}
            <div class="video-content">
              <div class="video-title">${video.title || "Bez tytułu"}</div>
              
              <div class="video-prediction">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span><strong>${topCategory}</strong></span>
                  <span style="opacity: 0.8;">${(topScore * 100).toFixed(1)}%</span>
                </div>
                <div class="prediction-bar">${predictionBar}</div>
              </div>

              ${tagsHtml ? `<div class="video-tags">${tagsHtml}</div>` : ""}

              <div class="video-links">
                <a href="${video.link}" target="_blank" class="video-link">
                  🔗 Zobacz
                </a>
                ${video.href ? `<a href="${video.href}" target="_blank" class="video-link download-link">⬇️ Pobierz</a>` : ""}
              </div>
            </div>
          `;

        resultsGrid.appendChild(card);
      });

      resultsSection.classList.remove("hidden");
    }

    // Wyświetl statystyki
    function displayStats(videos) {
      const statsGrid = document.getElementById("statsGrid");

      if (videos.length === 0) {
        statsGrid.innerHTML = "";
        return;
      }

      // Policz kategorie
      const categoryStats = {
        drawings: 0,
        hentai: 0,
        neutral: 0,
        porn: 0,
        sexy: 0,
      };

      videos.forEach((video) => {
        const prediction = video.prediction || {};
        let topCategory = "";
        let topScore = 0;

        Object.entries(prediction).forEach(([key, value]) => {
          if (typeof value === "number" && value > topScore) {
            topScore = value;
            topCategory = key;
          }
        });

        if (categoryStats.hasOwnProperty(topCategory)) {
          categoryStats[topCategory]++;
        }
      });

      const categoryNames = {
        drawings: "Drawing",
        hentai: "Hentai",
        neutral: "Neutral",
        porn: "Porn",
        sexy: "Sexy",
      };

      const statsHtml = Object.entries(categoryStats)
        .filter(([key, count]) => count > 0)
        .map(
          ([key, count]) => `
            <div class="stat-card">
              <div class="stat-number">${count}</div>
              <div class="stat-label">${categoryNames[key]}</div>
            </div>
          `,
        )
        .join("");

      statsGrid.innerHTML = `
          <div class="stat-card">
            <div class="stat-number">${videos.length}</div>
            <div class="stat-label">Łącznie video</div>
          </div>
          ${statsHtml}
        `;
    }

    // Uruchom aplikację
    init();
  </script>
</body>

</html>
